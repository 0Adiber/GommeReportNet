using System;
using System.Linq;
using System.Threading;
using System.Timers;
using OQ.MineBot.PluginBase;
using OQ.MineBot.PluginBase.Base.Plugin.Tasks;
using OQ.MineBot.PluginBase.Classes.Base;

namespace GommeRepoNet_Master.Tasks
{
    class Order : ITask {

        readonly string[] accounts;
        readonly string[] keys;
        readonly string[] authorised;
        readonly string cmd;

        DateTime cms;
        bool waiting = false;
        int rec = 0;
        int sent = 0;

        public Order(string[] accounts, string[] keys, string cmd, string[] authorised) {
            this.accounts = accounts;
            this.keys = keys;
            this.cmd = cmd;
            this.authorised = authorised;
        }

        public override bool Exec()
        {
           return true;
        }

        public override void Start() { player.events.onChat += OnChat; player.events.onTick += onTick; }
        public override void Stop() { player.events.onChat -= OnChat; player.events.onTick -= onTick; }

        private void OnChat(IPlayer player, IChat message, byte position)
        {
            string msg = message.GetText();

            if (msg.StartsWith("[Clans]"))
            {
                if (!msg.Contains(":")) return;
                string[] parts = msg.Split(new char[] { ':' });
                if (!parts[1].Trim().StartsWith(".")) return;

                string com = null;

                for (int i = 0; i < authorised.Length; i++)
                {
                    if (!parts[0].Contains(authorised[i])) continue;
                    for (int j = 0; j < keys.Length; j++)
                    {
                        if (!parts[1].Trim().Contains(keys[j])) continue;
                        com = parts[1].Trim().Split(new char[] { ' ' })[1];
                        break;
                    }
                }

                if(waiting)
                {
                    TimeSpan duration = DateTime.Now - cms;
                    player.functions.Chat("/cc [GommeReportNet] Es befindet sich gerade ein Report in arbeit. Bitte warte noch " + (3000 - duration.TotalMilliseconds) + "ms");
                    return;
                }

                if (!string.IsNullOrEmpty(com))
                {
                    player.functions.Chat("/" + cmd.Replace("%to_report%", com));
                    sent = 0;
                    for (int i = 0; i < accounts.Length; i++)
                    {
                        player.functions.Chat("/msg " + accounts[i] + " /" + cmd.Replace("%to_report%", com));
                        sent++;
                    }
                    player.functions.Chat("/cc [GommeReportNet] Der Report wurde an " + sent + " Bots geschickt.");
                    cms = DateTime.Now;
                    waiting = true;
                }

            } else if(msg.StartsWith("[Friends]"))
            {
                msg = msg.Replace("[Friends]", "");
                string[] parts = msg.Split(new char[] { ':' });
                if (msg.Trim().Equals("yes")) rec++;
            }
        }

        private void onTick(IPlayer player)
        {
            TimeSpan duration = DateTime.Now - cms;
            if ((duration.TotalMilliseconds >= 3000) && waiting)
            {
                player.functions.Chat("/cc [GommeReportNet] " + rec + "/" + sent + " Bots haben geantwortet.");
                waiting = false;
                rec = 0;
                sent = 0;
            }
        }

    }
}
